<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CBT Ujian Sekolah</title>
  <meta name="theme-color" content="#5D3A9B">
  <link rel="manifest" href="application/manifest+json,{%22name%22:%22CBT%20Ujian%22,%22short_name%22:%22CBT%22,%22start_url%22:%22.%22,%22display%22:%22standalone%22,%22background_color%22:%22%23f5f5f5%22,%22theme_color%22:%22%235D3A9B%22}">
  <style>
    :root {
      --primary: #5D3A9B;
      --disabled: #CCCCCC;
      --completed: #2E7D32;
      --warning: #FF9800;
      --danger: #D32F2F;
      --light: #f5f5f5;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: var(--light);
      padding: 16px;
      max-width: 600px;
      margin: 0 auto;
      font-size: 16px;
      overflow-x: hidden;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      margin: 12px auto; /* ‚Üê tambahkan 'auto' untuk center */
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
	  /* ‚úÖ Tambahkan ini untuk mengatur lebar */
	  width: 90%;        /* ‚Üê 90% dari lebar layar */
	  max-width: 400px;  /* ‚Üê maksimal 400px (tidak terlalu lebar di layar besar) */
    }

    .btn {
      display: block;
      width: 100%;
      padding: 14px;
      margin: 10px 0;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      cursor: pointer;
      font-weight: bold;
    }

    .btn:disabled {
      background-color: var(--disabled);
      cursor: not-allowed;
      color: #888;
    }

    .btn-completed {
      background-color: var(--completed) !important;
    }

    .timer {
      font-size: 24px;
      font-weight: bold;
      color: #333;
      text-align: center;
      margin: 16px 0;
      padding: 8px;
      background: #f9f9f9;
      border-radius: 8px;
    }

    .timer.warning { color: var(--warning); }
    .timer.danger { color: var(--danger); }

    .alert {
      background-color: #fff3cd;
      color: #856404;
      padding: 12px;
      border-radius: 8px;
      margin: 12px auto;
      border-left: 4px solid #ffc107;
      text-align: center;
	  width: 90%;        /* ‚Üê 90% dari lebar layar */
	  max-width: 400px;  /* ‚Üê maksimal 400px (tidak terlalu lebar di layar besar) */
    }

    .hidden { display: none; }
    .center { text-align: center; }

    input {
      width: 100%;
      padding: 12px;
      margin: 8px 0;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 16px;
    }

    iframe {
      width: 100%;
      height: 100%;
      border: none;
    }

    @media (max-width: 480px) {
      body { padding: 8px; }
      .card { padding: 12px; }
      .btn { padding: 12px; font-size: 16px; }
    }
  </style>
</head>
<body>
  <!-- LOGIN -->
  <div id="login-screen">
    <div class="card">
		 <img src="https://i.imgur.com/pckiPOg.png" 
         alt="Logo Sekolah" 
         style="display: block; margin: 0 auto 20px auto; width: 90px; height: 90px; border-radius: 0px; box-shadow: 0 2px 6px rgba(0,0,0,0.0);">
      <h2 class="center" style="margin-bottom:20px;">Login Siswa</h2>
      <input type="text" id="username" placeholder="Username (Nomor Peserta)" autocomplete="off">
      <input type="password" id="password" placeholder="Password" autocomplete="off">
      <button class="btn" onclick="login()">Login</button>
    </div>

    <div class="alert">
      <strong>üìå Petunjuk Penting:</strong><br>
      1. Buka link ini di <strong>Chrome (Android)</strong> atau <strong>Safari (iPhone)</strong><br>
      2. Klik <strong>‚ãÆ ‚Üí Add to Home Screen</strong><br>
      3. Buka dari <strong>ikon di home screen</strong> saat ujian<br>
      4. Jangan buka aplikasi lain saat ujian!
    </div>
  </div>

  <!-- HOME -->
  <div id="home-screen" class="hidden">
    <div class="card">
      <h3 id="user-info">Nama: ...</h3>
      <p><strong>Kelas:</strong> <span id="kelas"></span></p>
      <p><strong>Ruang:</strong> <span id="ruang"></span></p>
    </div>

    <div class="card">
      <h3>Ujian Hari Ini</h3>
      <div id="ujian-list"></div>
      <div id="no-ujian" class="alert">Tidak ada ujian untuk hari ini.</div>
    </div>

    <button class="btn" onclick="logout()">Logout</button>
  </div>

  <!-- EXAM -->
  <div id="exam-screen" class="hidden">
    <div class="card">
      <div class="timer" id="timer">--:--:--</div>
      <h3 id="exam-title">Loading...</h3>
      <p><strong>Pengampu:</strong> <span id="pengampu">-</span></p>
      <div id="exam-container" style="height: 60vh; width: 100%; border: 1px solid #eee; border-radius: 8px; margin: 12px 0; overflow: hidden;"></div>
    </div>
  </div>

  <script>
    // üîë Sudah diisi dengan URL Web App Anda
    const API_URL = 'https://script.google.com/macros/s/AKfycbzLUnK1MPN8HFhneM8M4wGlYLPZhnpuiMxuu1gq7xnOUx_hksfXVnAXct3wEVfzvekIpw/exec';
	
    // Cek apakah aplikasi berjalan di mode standalone
    function isStandaloneMode() {
      return window.matchMedia('(display-mode: standalone)').matches ||
             window.navigator.standalone === true;
    }

    // --- Functions ---
    function login() {
      var u = document.getElementById('username').value.trim();
      var p = document.getElementById('password').value.trim();
      if (!u || !p) {
        alert('Username dan password wajib diisi.');
        return;
      }

      fetch(API_URL + '?action=login&username=' + encodeURIComponent(u) + '&password=' + encodeURIComponent(p))
        .then(r => r.json())
        .then(function(data) {
          if (data.success) {
            localStorage.setItem('user', JSON.stringify(data.data));
            loadUjian();
            showScreen('home-screen');
          } else {
            alert(data.message || 'Login gagal.');
          }
        })
        .catch(function() {
          alert('Gagal terhubung ke server. Periksa koneksi internet.');
        });
    }

    function loadUjian() {
      var user = JSON.parse(localStorage.getItem('user'));
      if (!user) return;

      document.getElementById('user-info').textContent = 'Nama: ' + user.nama_lengkap;
      document.getElementById('kelas').textContent = user.kelas;
      document.getElementById('ruang').textContent = user.ruang;

      fetch(API_URL + '?action=ujian&username=' + user.username)
        .then(r => r.json())
        .then(function(data) {
          var list = document.getElementById('ujian-list');
          var no = document.getElementById('no-ujian');
          list.innerHTML = '';
          no.classList.add('hidden');

          if (!data.success || !data.ujianList || data.ujianList.length === 0) {
            no.classList.remove('hidden');
            return;
          }

          data.ujianList.forEach(function(ujian) {
            var btn = document.createElement('button');
            btn.className = 'btn';
            btn.textContent = ujian.mata_pelajaran + ' ‚Äì ' + (ujian.status === 'aktif' ? 'üü¢ Aktif' : ujian.status === 'belum mulai' ? '‚è≥ Belum Mulai' : '‚úÖ Selesai');
            btn.disabled = ujian.status !== 'aktif';

            if (ujian.status === 'aktif') {
              btn.onclick = function() { startExam(ujian); };
            }
            list.appendChild(btn);
          });
        })
        .catch(function() {
          alert('Gagal memuat daftar ujian.');
        });
    }

    function startExam(ujian) {
      if (!isStandaloneMode()) {
        alert('‚ö†Ô∏è Ujian hanya bisa dimulai dalam mode layar penuh.\n\n1. Buka halaman ini di Chrome/Safari\n2. Klik ‚ãÆ ‚Üí "Add to Home Screen"\n3. Buka dari ikon di home screen');
        return;
      }

      // Cek apakah sudah pernah mulai
      var startedExams = JSON.parse(localStorage.getItem('startedExams') || '[]');
      if (startedExams.includes(ujian.soal_id)) {
        alert('Ujian ini sudah pernah Anda mulai. Tidak bisa diakses ulang.');
        return;
      }

      // Tandai bahwa ujian ini sudah dimulai
      startedExams.push(ujian.soal_id);
      localStorage.setItem('startedExams', JSON.stringify(startedExams));

      fetch(API_URL + '?action=exam&soal_id=' + ujian.soal_id)
        .then(r => r.json())
        .then(function(data) {
          if (!data.success) {
            alert('Soal tidak tersedia.');
            return;
          }

          var waktuSelesaiStr = data.waktu_selesai;
          var tanggalUjian = data.tanggal_ujian;

          var [jam, menit] = waktuSelesaiStr.split(':').map(Number);
          var waktuSelesai = new Date(
            parseInt(tanggalUjian.split('-')[0]),
            parseInt(tanggalUjian.split('-')[1]) - 1,
            parseInt(tanggalUjian.split('-')[2]),
            jam,
            menit
          );

          var sekarang = new Date();
          var sisaDetik = Math.floor((waktuSelesai - sekarang) / 1000);

          if (sisaDetik <= 0) {
            alert('Waktu ujian sudah habis.');
            loadUjian();
            showScreen('home-screen');
            return;
          }

          var examInfo = {
            soal_id: ujian.soal_id,
            title: ujian.mata_pelajaran,
            pengampu: ujian.pengampu,
            link: data.link,
            waktu_selesai: waktuSelesai.getTime()
          };
          localStorage.setItem('currentExam', JSON.stringify(examInfo));

          document.getElementById('exam-title').textContent = ujian.mata_pelajaran;
          document.getElementById('pengampu').textContent = ujian.pengampu;

          document.getElementById('exam-container').innerHTML = `
            <div style="background:#fff3cd; color:#856404; padding:12px; text-align:center; border-radius:8px; margin-bottom:12px; font-weight:bold;">
              ‚ö†Ô∏è JANGAN TUTUP HALAMAN! Klik tombol Submit di bawah Google Form!
            </div>
            <iframe src="${data.link}" style="width:100%; height:calc(100% - 60px); border:none;"></iframe>
          `;

          startTimer(sisaDetik);
          showScreen('exam-screen');
        })
        .catch(function() {
          alert('Gagal memuat soal.');
        });
    }

    var timerInterval;
    function startTimer(totalSeconds) {
      var sec = totalSeconds;
      var timerEl = document.getElementById('timer');

      var format = function(s) {
        var h = Math.floor(s / 3600);
        var m = Math.floor((s % 3600) / 60);
        var ss = s % 60;
        return h.toString().padStart(2,'0') + ':' + m.toString().padStart(2,'0') + ':' + ss.toString().padStart(2,'0');
      };

      timerEl.textContent = format(sec);
      timerEl.className = 'timer';

      timerInterval = setInterval(function() {
        sec--;
        timerEl.textContent = format(sec);

        if (sec <= 120) timerEl.classList.add('warning');
        if (sec <= 60) timerEl.classList.add('danger');

        if (sec <= 0) {
          clearInterval(timerInterval);
          alert('‚è∞ Waktu habis! Pastikan Anda submit jawaban di Google Form.');
          loadUjian();
          showScreen('home-screen');
        }
      }, 1000);
    }

    function logout() {
      localStorage.clear();
      showScreen('login-screen');
      document.getElementById('username').value = '';
      document.getElementById('password').value = '';
    }

    function showScreen(id) {
      var screens = document.querySelectorAll('div[id$="-screen"]');
      for (var i = 0; i < screens.length; i++) {
        screens[i].classList.add('hidden');
      }
      document.getElementById(id).classList.remove('hidden');
    }

    // üîí ANTI-CHEATING
    var violationCount = 0;

    document.addEventListener('visibilitychange', function() {
      if (document.hidden && !document.getElementById('exam-screen').classList.contains('hidden')) {
        violationCount++;
        if (violationCount === 1) {
          alert('‚ö†Ô∏è PERINGATAN 1: Jangan tinggalkan halaman ujian!');
        } else if (violationCount >= 2) {
          alert('üö® PELANGGARAN KE-2! Anda akan logout otomatis.');
          logout();
        }
      }
    });

    // Block actions
    document.addEventListener('copy', function(e) { e.preventDefault(); }, true);
    document.addEventListener('paste', function(e) { e.preventDefault(); }, true);
    document.addEventListener('cut', function(e) { e.preventDefault(); }, true);
    document.addEventListener('contextmenu', function(e) { e.preventDefault(); }, true);

    document.addEventListener('keydown', function(e) {
      if (
        e.key === 'F12' ||
        e.ctrlKey && (e.key === 'u' || e.key === 'U') ||
        e.ctrlKey && e.shiftKey && (e.key === 'I' || e.key === 'i' || e.key === 'J' || e.key === 'j' || e.key === 'C' || e.key === 'c')
      ) {
        e.preventDefault();
        alert('üîí Fitur ini dinonaktifkan selama ujian.\n\nAnda akan logout otomatis.');
        logout();
      }
    }, true);

    // Auto-login if already logged in
    window.onload = function() {
      if (localStorage.getItem('user')) {
        loadUjian();
        showScreen('home-screen');
      }
    };

    // Prevent zoom (mobile)
    document.addEventListener('touchmove', function(e) {
      if (e.scale !== 1) e.preventDefault();
    }, { passive: false });
  </script>
</body>
</html>
